<script>
    const API_KEY = "AIzaSyCTjzqIMDnxY8AfnoGjqihcaOPViuxhxy0"; // API bạn cung cấp
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;

    const features = {
        'Chatbot Thổ Địa': {
            icon: '<i class="fa-regular fa-comments"></i>',
            content: `
                <div id="chat-box" class="space-y-4">
                    <div class="chat-bubble bg-orange-500/20 border border-orange-500/20 text-orange-100">
                        <b>Anh Tư:</b> Chu cha! Chào bạn tới thăm Quy Nhơn nhen. Tui là Anh Tư Nẫu - "thổ địa" ở đây. Bạn muốn hỏi đường đi, chỗ ăn ngon hay khách sạn giá rẻ cứ nói tui nghe!
                    </div>
                </div>
            `
        },
        'Bản đồ Khám phá': {
            icon: '<i class="fa-solid fa-location-dot"></i>',
            content: `<div class="grid grid-cols-1 gap-4">...</div>` // Giữ nguyên nội dung cũ của bạn
        },
        'Audio Thuyết minh': {
            icon: '<i class="fa-solid fa-headphones"></i>',
            content: `<div class="space-y-4">...</div>` // Giữ nguyên nội dung cũ của bạn
        },
        'Học Tiếng Nẫu': {
            icon: '<i class="fa-solid fa-book-open"></i>',
            content: `<div class="grid grid-cols-1 md:grid-cols-2 gap-3">...</div>` // Giữ nguyên nội dung cũ của bạn
        }
    };

    function openFeature(name) {
        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const icon = document.getElementById('modal-icon');
        const content = document.getElementById('modal-content');
        const chatArea = document.getElementById('chat-input-area');

        modal.classList.remove('hidden');
        title.innerText = name;
        icon.innerHTML = features[name].icon;
        
        // Chỉ cập nhật content nếu không phải là Chatbot để tránh mất lịch sử chat
        if (name !== 'Chatbot Thổ Địa') {
            content.innerHTML = features[name].content;
            chatArea.classList.add('hidden');
        } else {
            if (!document.getElementById('chat-box')) {
                content.innerHTML = features[name].content;
            }
            chatArea.classList.remove('hidden');
        }
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
    }

    // --- LOGIC GỌI API GEMINI THẬT ---
    async function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('ai-input');
        const chatBox = document.getElementById('chat-box');
        const userText = input.value.trim();
        
        if (!userText) return;

        // 1. Hiển thị tin nhắn của bạn
        chatBox.innerHTML += `<div class="chat-bubble bg-white/10 ml-auto border border-white/10"><b>Bạn:</b> ${userText}</div>`;
        input.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        // 2. Hiển thị trạng thái chờ
        const loadingDiv = document.createElement('div');
        loadingDiv.className = "chat-bubble bg-orange-500/10 italic text-gray-400";
        loadingDiv.innerHTML = "Anh Tư đang suy nghĩ...";
        chatBox.appendChild(loadingDiv);

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `Bạn là 'Anh Tư Nẫu', một chuyên gia du lịch tại Quy Nhơn. 
                            Hãy trả lời bằng giọng điệu mộc mạc, thân thiện của người Bình Định. 
                            Sử dụng các từ ngữ như 'Nẫu', 'Chu cha', 'Dẫy nhen', 'Lắm nghen'. 
                            Nhiệm vụ: Tư vấn ăn uống, điểm chơi và văn hóa Quy Nhơn.
                            Câu hỏi khách: ${userText}`
                        }]
                    }]
                })
            });

            const data = await response.json();
            const botReply = data.candidates[0].content.parts[0].text;

            // 3. Xóa trạng thái chờ và hiển thị câu trả lời từ AI
            chatBox.removeChild(loadingDiv);
            chatBox.innerHTML += `
                <div class="chat-bubble bg-orange-500/20 border border-orange-500/20 text-orange-100">
                    <b>Anh Tư:</b> ${botReply}
                </div>`;
            
        } catch (error) {
            chatBox.removeChild(loadingDiv);
            chatBox.innerHTML += `<div class="chat-bubble bg-red-500/20 text-red-200">Anh Tư xỉn rồi, đợi xíu nhen (Lỗi kết nối)!</div>`;
            console.error(error);
        }

        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
